<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Bus Transport</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
         body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f4f8; color: #1a202c; }

     .admin-shell { max-width: 1400px; margin: 100px auto 40px; padding: 0 20px 40px; }
     
     /* Header Section */
     .admin-top { 
       display:flex; 
       align-items:center; 
       justify-content:space-between; 
       margin-bottom: 24px; 
       background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
       padding: 20px 24px;
       border-radius: 12px;
       color: white;
       box-shadow: 0 4px 20px rgba(30, 64, 175, 0.3);
     }
    .admin-title { font-size: 1.8rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    .admin-title::before { content: 'üöå'; font-size: 1.5rem; }
    .logout { 
      background: rgba(255,255,255,0.2); 
      border: 1px solid rgba(255,255,255,0.3); 
      padding: 10px 18px; 
      border-radius: 8px; 
      cursor:pointer; 
      color: white;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .logout:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); }

         /* Navigation Tabs */
     .admin-nav { display:flex; gap:8px; margin-bottom: 20px; background: white; padding: 8px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
     .admin-tab { 
       padding:12px 24px; 
       border: none;
       background: transparent;
       color: #64748b;
       border-radius:8px; 
       cursor:pointer;
       font-weight: 600;
       transition: all 0.3s ease;
       position: relative;
     }
     .admin-tab.active { 
       background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
       color: #fff;
       box-shadow: 0 4px 12px rgba(30, 64, 175, 0.4);
     }
     .admin-tab:not(.active):hover {
       background: #f0f4f8;
       color: #1a202c;
     }

    /* Card Styles */
    .card { 
      background: #ffffff; 
      border: 1px solid #e7eef5; 
      border-radius: 16px; 
      padding: 24px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      transition: all 0.3s ease;
    }
    .card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.08); }
         .section-title { 
       font-weight: 700; 
       font-size: 1.3rem;
       margin-bottom: 16px; 
       color: #1e40af;
       display: flex;
       align-items: center;
       gap: 8px;
     }

    /* Dashboard Table */
    table.admin-table { 
      width:100%; 
      border-collapse: collapse; 
      margin-top: 8px;
    }
    .admin-table th, .admin-table td { 
      padding:14px 16px; 
      border-bottom: 1px solid #e7eef5; 
      text-align:left; 
    }
         .admin-table th { 
       background: linear-gradient(to right, #eff6ff, #dbeafe);
       font-weight: 700;
       color: #1e40af;
       font-size: 0.9rem;
       text-transform: uppercase;
       letter-spacing: 0.5px;
     }
     .admin-table tr:hover { background: #f0f4f8; }
     .badge { 
       padding: 6px 12px; 
       border-radius: 20px; 
       font-size: 0.85rem; 
       font-weight: 600;
       display: inline-block;
     }
     .badge-ok { background: #dbeafe; color: #1e40af; }
     .badge-no { background: #fecaca; color: #991b1b; }

    /* Form Styles */
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    .grid-3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:16px; }
         .form-input { 
       width:100%; 
       padding:12px 16px; 
       border: 2px solid #cbd5e1; 
       border-radius: 10px; 
       font-size: 0.95rem;
       transition: all 0.3s ease;
     }
     .form-input:focus {
       outline: none;
       border-color: #3b82f6;
       box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
     }
     .form-group { display: flex; flex-direction: column; gap: 8px; }
     .form-group label { font-weight: 600; color: #1e40af; font-size: 0.9rem; }
    .btn { 
      padding:12px 20px; 
      border-radius: 10px; 
      border: none;
      font-weight: 600;
      cursor:pointer; 
      transition: all 0.3s ease;
      font-size: 0.95rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
         .btn.primary { 
       background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
       color: #fff;
       box-shadow: 0 4px 12px rgba(30, 64, 175, 0.4);
     }
     .btn.primary:hover { 
       transform: translateY(-2px);
       box-shadow: 0 6px 16px rgba(30, 64, 175, 0.5);
     }
     .btn.danger { 
       background: #dc2626; 
       color: #fff;
       box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
     }
     .btn.danger:hover { 
       background: #991b1b;
       transform: translateY(-2px);
     }
     .btn:not(.primary):not(.danger) {
       background: #f0f4f8;
       color: #1e40af;
       border: 2px solid #cbd5e1;
     }
     .btn:not(.primary):not(.danger):hover {
       background: #dbeafe;
       border-color: #93c5fd;
     }
    .small { font-size:0.9rem; color:#64748b; }
    .loading { text-align:center; padding:40px; color:#94a3b8; font-size: 1.1rem; }
         .error { 
       color: #991b1b; 
       background: #fee2e2; 
       padding: 14px 18px; 
       border-radius: 10px; 
       margin: 10px 0;
       border-left: 4px solid #dc2626;
       display: flex;
       align-items: center;
       gap: 8px;
     }
     .error::before { content: '‚ö†Ô∏è'; font-size: 1.2rem; }
     .success { 
       color: #1e40af; 
       background: #dbeafe; 
       padding: 14px 18px; 
       border-radius: 10px; 
       margin: 10px 0;
       border-left: 4px solid #3b82f6;
       display: flex;
       align-items: center;
       gap: 8px;
     }
     .success::before { content: '‚úì'; font-weight: bold; }
    .list { display:flex; flex-direction:column; gap:12px; margin-top:16px; }
    .item { 
      display:flex; 
      align-items:center; 
      justify-content:space-between; 
      padding:16px 18px; 
      border: 2px solid #e7eef5; 
      border-radius: 12px;
      background: white;
      transition: all 0.3s ease;
    }
    .item:hover { border-color: #cbd5e1; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

    /* Modal Styles */
         .item.dragging {
       opacity: 0.5;
       background: #dbeafe;
       transform: scale(0.95);
     }
     .item.drag-over {
       border-top: 3px solid #3b82f6;
       border-color: #3b82f6;
     }

    .modal { 
      display: none; 
      position: fixed; 
      z-index: 1000; 
      left: 0; 
      top: 0; 
      width: 100%; 
      height: 100%; 
      overflow: auto; 
      background-color: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
    }
    .modal-content { 
      background-color: #ffffff; 
      margin: 3% auto; 
      padding: 0; 
      border: none;
      width: 90%; 
      max-width: 1000px; 
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: modalSlideIn 0.3s ease-out;
    }
    @keyframes modalSlideIn {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }
         .modal-header { 
       display: flex; 
       justify-content: space-between; 
       align-items: center; 
       padding: 24px 28px; 
       background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
       border-radius: 20px 20px 0 0;
     }
    .modal-header h2 { 
      margin: 0; 
      font-size: 1.6rem; 
      color: white;
      font-weight: 700;
    }
    .modal-close { 
      color: white; 
      font-size: 32px; 
      font-weight: bold; 
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }
    .modal-close:hover { 
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(90deg);
    }
    .modal-body { 
      padding: 28px; 
      max-height: calc(90vh - 100px);
      overflow-y: auto;
    }
    
    /* Route Editor Tabs */
         .route-editor-tabs { 
       display: flex; 
       gap: 12px; 
       margin-bottom: 24px; 
       border-bottom: 2px solid #cbd5e1;
       padding-bottom: 0;
     }
     .route-editor-tab { 
       padding: 14px 24px; 
       border: none;
       background: transparent;
       cursor: pointer; 
       border-bottom: 3px solid transparent;
       font-weight: 600;
       color: #64748b;
       transition: all 0.3s ease;
       margin-bottom: -2px;
     }
     .route-editor-tab.active { 
       color: #3b82f6;
       border-bottom-color: #3b82f6;
       background: rgba(59, 130, 246, 0.05);
     }
     .route-editor-tab:not(.active):hover {
       color: #1a202c;
       background: #f0f4f8;
     }
    .route-editor-section { display: none; }
    .route-editor-section.active { display: block; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .admin-shell { margin-top: 80px; }
      .admin-top { flex-direction: column; gap: 16px; text-align: center; }
      .grid-3, .grid-2 { grid-template-columns: 1fr; }
      .modal-content { width: 95%; margin: 5% auto; }
      .admin-nav { flex-direction: column; }
    }

    /* Scrollbar Styling */
    .modal-body::-webkit-scrollbar,
    div::-webkit-scrollbar {
      width: 8px;
    }
    .modal-body::-webkit-scrollbar-track,
    div::-webkit-scrollbar-track {
      background: #f1f5f9;
    }
    .modal-body::-webkit-scrollbar-thumb,
    div::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }
    .modal-body::-webkit-scrollbar-thumb:hover,
    div::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    @keyframes fadeInRow {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Status Filter Dropdown */
         #statusFilter {
       padding: 6px 12px;
       border-radius: 8px;
       border: 2px solid #cbd5e1;
       background: white;
       font-weight: 600;
       color: #1e40af;
       cursor: pointer;
       transition: all 0.3s ease;
     }
     #statusFilter:hover {
       border-color: #3b82f6;
     }
     #statusFilter:focus {
       outline: none;
       border-color: #3b82f6;
       box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
     }
  </style>
  <script>
  // Use site origin so deployed site doesn't call localhost
  const API_BASE = `${window.location.origin}/api`;
  let currentBuses = [];
  // Map real bus number -> display single-series number
  const busNumberToDisplay = new Map();
  let currentLogs = [];
  let statusFilterValue = 'all'; // To hold the current filter status

  // Use same localStorage key used by login
  const ADMIN_TOKEN_KEY = "adminToken";

  // Add switchTab implementation (was missing) ------------------------------------------------
  function switchTab(tabId) {
    // hide all panes
    document.querySelectorAll('[data-pane]').forEach(el => el.style.display = 'none');
    // show target pane
    const pane = document.getElementById(tabId);
    if (pane) pane.style.display = 'block';

    // update tab button active state
    document.querySelectorAll('.admin-tab').forEach(btn => {
      const isActive = btn.dataset.tab === tabId;
      btn.classList.toggle('active', isActive);
    });

    // optional: scroll to top of dashboard when switching
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
  // -----------------------------------------------------------------------------------------

  function ensureAuth() {
    const token = localStorage.getItem(ADMIN_TOKEN_KEY);
    if (!token) {
      window.location.href = '/admin.html';
      return false;
    }
    return true;
  }

  function logout() {
    localStorage.removeItem(ADMIN_TOKEN_KEY);
    window.location.href = '/admin.html';
  }

  async function makeApiCall(endpoint, method = 'GET', data = null, isLegacy = false) {
    const token = localStorage.getItem(ADMIN_TOKEN_KEY);
    const options = {
      method,
      headers: {
        'Content-Type': 'application/json',
      }
    };
    if (token) options.headers['Authorization'] = `Bearer ${token}`;

    if (data) options.body = JSON.stringify(data);

    try {
      const url = isLegacy ? `${window.location.origin}${endpoint}` : `${API_BASE}${endpoint}`;
      const response = await fetch(url, options);
      const result = await response.json().catch(() => ({}));
      if (!response.ok) {
        throw new Error(result.message || 'API call failed');
      }
      return result;
    } catch (error) {
      console.error('API Error:', error);
      showError(error.message);
      throw error;
    }
  }

    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error';
      errorDiv.textContent = message;
      document.body.insertBefore(errorDiv, document.body.firstChild);
      setTimeout(() => errorDiv.remove(), 5000);
    }

    function showSuccess(message) {
      const successDiv = document.createElement('div');
      successDiv.className = 'success';
      successDiv.textContent = message;
      document.body.insertBefore(successDiv, document.body.firstChild);
      setTimeout(() => successDiv.remove(), 3000);
    }

    async function loadLogs() {
      try {
        const result = await makeApiCall('/admin/logs', 'GET', null, true);
        currentLogs = result.logs || [];
        renderDashboard();
      } catch (error) {
        console.error('Failed to load logs:', error);
      }
    }

// Load all buses from backend and render in UI
async function loadBuses() {
  try {
    const res = await fetch('/api/routes'); // ‚úÖ uses your working route endpoint
    const data = await res.json();

    const listContainer = document.getElementById('busList'); // Ensure <div id="busList"> exists
    listContainer.innerHTML = "";

    if (!data.success || !data.routes || data.routes.length === 0) {
      listContainer.innerHTML = `<p style="text-align:center; color:#666;">No buses found in the database.</p>`;
      return;
    }

    data.routes.forEach(bus => {
      const busCard = document.createElement('div');
      busCard.className = "bus-card";
      busCard.innerHTML = `
        <div class="bus-info">
          <h3>üöå ${bus.number} - ${bus.name}</h3>
          <p><b>Location:</b> ${bus.location}</p>
          <p><b>Capacity:</b> ${bus.capacity || 'N/A'}</p>
        </div>
        <div class="bus-actions">
          <button class="edit-btn" data-id="${bus.id}">‚úèÔ∏è Edit</button>
          <button class="stops-btn" data-id="${bus.id}">üó∫Ô∏è Edit Stops</button>
          <button class="delete-btn" data-id="${bus.id}">üóëÔ∏è Delete</button>
        </div>
      `;
      listContainer.appendChild(busCard);
    });
  } catch (err) {
    console.error("Error loading buses:", err);
    const listContainer = document.getElementById('busList');
    listContainer.innerHTML = `<p style="text-align:center; color:red;">Failed to load buses. Check server.</p>`;
  }
}


    function filterLogsByStatus() {
      statusFilterValue = document.getElementById('statusFilter').value;
      renderDashboard();
    }

    function renderDashboard() {
      const tbody = document.getElementById('eventsBody');

      const filteredLogs = currentLogs.filter(log => {
        if (statusFilterValue === 'all') return true;
        return log.status === statusFilterValue;
      });

      if (filteredLogs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="loading">No logs available for this status</td></tr>';
        return;
      }

      tbody.innerHTML = filteredLogs.map(log => {
        const loc = (() => {
          if (log.locationName && typeof log.lat === 'number' && typeof log.lng === 'number') {
            return `${log.locationName} (${log.lat},${log.lng})`;
          }
          return log.location || '';
        })();
        return `
        <tr style="animation: fadeInRow 0.3s ease-out;">
          <td>üìÖ ${new Date(log.createdAt).toLocaleDateString()}</td>
          <td>üïê ${new Date(log.createdAt).toLocaleTimeString()}</td>
          <td>‚úâÔ∏è ${log.email}</td>
          <td>üìç ${loc}</td>
          <td><span class="badge ${log.status === 'AVAILABLE' ? 'badge-ok' : 'badge-no'}">${log.status === 'AVAILABLE' ? '‚úì ' : '‚úó '}${log.status}</span></td>
        </tr>
      `}).join('');
    }

    function renderBuses() {
      const list = document.getElementById('busList');
      if (currentBuses.length === 0) {
        list.innerHTML = '<div class="loading">No buses found</div>';
        return;
      }

            list.innerHTML = currentBuses.map((bus, idx) => {
        const displayNum = busNumberToDisplay.get(String(bus.number)) || String(bus.number);
        return `
         <div class="item">
           <div>
            <strong style="font-size: 1.1rem; color: #1e40af;">üöå Bus ${displayNum}</strong> 
            <div style="color: #64748b; margin-top: 4px;">${bus.name} ‚Ä¢ ${bus.location}</div>
           </div>
           <div style="display: flex; gap: 8px;">
             <button class="btn" onclick="editRoutes('${bus.number}')">‚úèÔ∏è Edit Routes</button>
             <button class="btn danger" onclick="removeBus('${bus.number}')">üóëÔ∏è Delete</button>
           </div>
         </div>
      `}).join('');
    }

    async function addBus(e) {
      e.preventDefault();
      const num = document.getElementById('busNumber').value.trim();
      const name = document.getElementById('busName').value.trim();
      const location = document.getElementById('busLocation').value.trim();
      
      if (!num || !name || !location) {
        showError('Please fill in all fields');
        return;
      }

      try {
        await makeApiCall('/admin/buses', 'POST', {
          number: num,
          name: name,
          location: location
        });
        
        showSuccess('Bus added successfully!');
        e.target.reset();
        await loadBuses();
      } catch (error) {
        // Error already shown by makeApiCall
      }
    }

    async function removeBus(busNumber) {
      if (!confirm(`Are you sure you want to delete Bus ${busNumber}?`)) {
        return;
      }

      try {
        await makeApiCall(`/admin/buses/${busNumber}`, 'DELETE', null, true);
        showSuccess('Bus deleted successfully!');
        await loadBuses();
      } catch (error) {
        // Error already shown by makeApiCall
      }
    }

    // Route editor
    const routeState = {
      morning: [],
      evening: [],
      capacity: 60,
      currentOccupancy: 0,
      driverName: "",
      driverPhone: "",
      liveLocationUrl: "",
      currentBusNumber: null,
      editing: {
        morning: null, // index of stop being edited, or null
        evening: null
      }
    };

    async function editRoutes(busNumber) {
      routeState.currentBusNumber = busNumber;
      
      // Load existing routes for this bus
      routeState.morning = [];
      routeState.evening = [];
      const bus = currentBuses.find(b => b.number === busNumber);
      if (bus) {
        routeState.capacity = bus.capacity ?? 60;
        routeState.currentOccupancy = bus.currentOccupancy ?? 0;
        routeState.driverName = bus.driverName ?? "";
        routeState.driverPhone = bus.driverPhone ?? "";
        routeState.liveLocationUrl = bus.liveLocationUrl ?? "";
        routeState.morning = bus.stops.filter(s => s.period === 'MORNING').map(s => ({
          name: s.name,
          coords: `${s.lat},${s.lng}`
        })).sort((a, b) => a.order - b.order);
        routeState.evening = bus.stops.filter(s => s.period === 'EVENING').map(s => ({
          name: s.name,
          coords: `${s.lat},${s.lng}`
        })).sort((a, b) => a.order - b.order);
      }

      const displayNum = busNumberToDisplay.get(String(busNumber)) || String(busNumber);
      document.getElementById('modalRouteEditorTitle').textContent = `Edit Routes ‚Äì Bus ${displayNum}`;
      document.getElementById('busCapacityInput').value = routeState.capacity;
      document.getElementById('modalBusName').value = bus.name;
      document.getElementById('modalBusLocation').value = bus.location;
      document.getElementById('modalDriverName').value = routeState.driverName;
      document.getElementById('modalDriverPhone').value = routeState.driverPhone;
      document.getElementById('modalLiveLocation').value = routeState.liveLocationUrl;
      document.getElementById('currentOccupancyInput').value = routeState.currentOccupancy;
      openRouteEditorModal();
    }

    function openRouteEditorModal() {
      document.getElementById('routeEditorModal').style.display = 'block';
      switchRouteEditorTab('morning');
    }

    function closeRouteEditorModal() {
      document.getElementById('routeEditorModal').style.display = 'none';
    }

    function addStop(period) {
      const nameEl = document.getElementById(`${period}StopName`);
      const coordEl = document.getElementById(`${period}StopCoords`);
      const name = nameEl.value.trim();
      const coords = coordEl.value.trim();
      
      if (!name || !coords) {
        showError('Please fill in both stop name and coordinates');
        return;
      }

      // Validate coordinates format
      const coordParts = coords.split(',');
      if (coordParts.length !== 2 || isNaN(coordParts[0]) || isNaN(coordParts[1])) {
        showError('Coordinates must be in format: lat,lng (e.g., 16.5062,80.6480)');
        return;
      }

      routeState[period].push({ name, coords });
      nameEl.value = '';
      coordEl.value = '';
      renderStops(period);
    }

    function renderStops(period) {
      const box = document.getElementById(`${period}Stops`);
      box.innerHTML = ''; // Clear existing stops

      let draggedIndex = null;
      const isEditingThisPeriod = (index) => routeState.editing[period] === index;

      if (routeState[period].length === 0) {
        box.innerHTML = '<div class="small" style="text-align:center; padding:10px;">No stops added yet.</div>';
        return;
      }

      routeState[period].forEach((s, i) => {
        const item = document.createElement('div');
        item.className = 'item';
        item.setAttribute('draggable', 'true');
        item.dataset.index = i;

        if (isEditingThisPeriod(i)) {
          item.innerHTML = `
            <div style="flex:1; display:flex; gap:8px;">
              <input class="form-input" id="edit-stop-name-${period}" value="${s.name}">
              <input class="form-input" id="edit-stop-coords-${period}" value="${s.coords}">
            </div>
            <div>
              <button class="btn primary" onclick="saveStopEdit('${period}', ${i})">‚úì Save</button>
              <button class="btn" onclick="cancelStopEdit('${period}')">‚úó Cancel</button>
            </div>
          `;
        } else {
          item.innerHTML = `
            <div>${i + 1}. ${s.name} <span class="small">(${s.coords})</span></div>
            <div>
              <button class="btn" onclick="toggleEdit('${period}', ${i})">‚úèÔ∏è Edit</button>
              <button class="btn danger" onclick="removeStop('${period}', ${i})">üóëÔ∏è Remove</button>
            </div>
          `;
        }

        // Drag and Drop event listeners
        item.addEventListener('dragstart', (e) => {
          draggedIndex = i;
          e.target.classList.add('dragging');
        });

        item.addEventListener('dragend', (e) => {
          e.target.classList.remove('dragging');
          draggedIndex = null;
        });

        item.addEventListener('dragover', (e) => {
          e.preventDefault();
          document.querySelectorAll(`#${period}Stops .item`).forEach(el => el.classList.remove('drag-over'));
          e.currentTarget.classList.add('drag-over');
        });

        item.addEventListener('dragleave', (e) => {
          e.currentTarget.classList.remove('drag-over');
        });

        item.addEventListener('drop', (e) => {
          e.preventDefault();
          document.querySelectorAll(`#${period}Stops .item`).forEach(el => el.classList.remove('drag-over'));
          const droppedOnIndex = i;
          moveStop(period, draggedIndex, droppedOnIndex);
        });

        box.appendChild(item);
      });
    }

    function removeStop(period, idx) { 
      routeState[period].splice(idx, 1); 
      renderStops(period); 
    }

    function toggleEdit(period, index) {
      // Cancel any other edit in the same modal
      routeState.editing.morning = null;
      routeState.editing.evening = null;
      routeState.editing[period] = index;
      renderStops('morning');
      renderStops('evening');
    }

    function saveStopEdit(period, index) {
      const newName = document.getElementById(`edit-stop-name-${period}`).value.trim();
      const newCoords = document.getElementById(`edit-stop-coords-${period}`).value.trim();

      if (!newName || !newCoords) {
        showError('Stop name and coordinates cannot be empty.');
        return;
      }

      routeState[period][index] = { name: newName, coords: newCoords };
      routeState.editing[period] = null;
      renderStops(period);
    }

    function cancelStopEdit(period) {
      routeState.editing[period] = null;
      renderStops(period);
    }

    function moveStop(period, fromIndex, toIndex) {
      if (fromIndex === null || fromIndex === toIndex) return;

      const item = routeState[period].splice(fromIndex, 1)[0];
      routeState[period].splice(toIndex, 0, item);

      // Re-render to update order and numbering
      renderStops(period);
    }

    async function saveRoutes() {
      if (!routeState.currentBusNumber) {
        showError('No bus selected for route editing');
        return;
      }

      try {
        const capacity = parseInt(document.getElementById('busCapacityInput').value, 10);
        const currentOccupancy = parseInt(document.getElementById('currentOccupancyInput').value, 10);
        const name = document.getElementById('modalBusName').value.trim();
        const location = document.getElementById('modalBusLocation').value.trim();
        const driverName = document.getElementById('modalDriverName').value.trim();
        const driverPhone = document.getElementById('modalDriverPhone').value.trim();
        const liveLocationUrl = document.getElementById('modalLiveLocation').value.trim();

        const morningStops = routeState.morning.map((s, i) => {
          const [lat, lng] = s.coords.split(',');
          return { name: s.name, lat: parseFloat(lat), lng: parseFloat(lng), order: i + 1 };
        });

        const eveningStops = routeState.evening.map((s, i) => {
          const [lat, lng] = s.coords.split(',');
          return { name: s.name, lat: parseFloat(lat), lng: parseFloat(lng), order: i + 1 };
        });

        await makeApiCall(`/admin/buses/${routeState.currentBusNumber}`, 'PUT', {
          name: name || currentBuses.find(b => b.number === routeState.currentBusNumber).name,
          location: location || currentBuses.find(b => b.number === routeState.currentBusNumber).location,
          capacity: isNaN(capacity) ? 60 : capacity,
          driverName,
          driverPhone,
          liveLocationUrl: liveLocationUrl,
          currentOccupancy: isNaN(currentOccupancy) ? 0 : currentOccupancy,
          morningStops,
          eveningStops
        });

        showSuccess('Routes saved successfully!');
        closeRouteEditorModal();
        await loadBuses();
      } catch (error) {
        // Error already shown by makeApiCall
      }
    }

    function switchRouteEditorTab(period) {
      // When switching tabs, cancel any ongoing edit
      routeState.editing.morning = null;
      routeState.editing.evening = null;
      document.querySelectorAll('.route-editor-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.route-editor-section').forEach(s => s.style.display = 'none');
      document.querySelector(`[data-route-tab="${period}"]`).classList.add('active');
      document.getElementById(`${period}RouteSection`).style.display = 'block';
      renderStops(period);
    }

window.addEventListener('load', async () => {
  if (!ensureAuth()) return;
  
  // Default to bus management tab so admins see changes immediately
  switchTab('busesPane');
  
  try {
    const me = await makeApiCall('/admin/me', 'GET');
    if (me && me.admin && me.admin.role === 'superadmin') {
      document.getElementById('approvalsTab').style.display = 'inline-block';
    }
  } catch (e) {
    console.warn('Failed to check admin role', e);
  }

  // Load all data sets freshly
  await loadBuses();
  await loadLogs();
});


    async function loadSettings() {
      try {
        const res = await fetch(`${API_BASE.replace('/api', '')}/api/settings`);
        const data = await res.json();
        if (!data.success) return;
        const s = data.settings || {};
        document.getElementById('settingsTitle').value = s.siteTitle || '';
        document.getElementById('settingsOrg').value = s.organizationName || '';
        document.getElementById('settingsAddress').value = s.contact?.address || '';
        document.getElementById('settingsPhone').value = s.contact?.phone || '';
        document.getElementById('settingsEmail').value = s.contact?.email || '';
      } catch (e) {
        // ignore
      }
    }

    async function saveSettings(e) {
      e.preventDefault();
      try {
        const payload = {
          siteTitle: document.getElementById('settingsTitle').value.trim(),
          organizationName: document.getElementById('settingsOrg').value.trim(),
          contact: {
            address: document.getElementById('settingsAddress').value.trim(),
            phone: document.getElementById('settingsPhone').value.trim(),
            email: document.getElementById('settingsEmail').value.trim()
          }
        };
        await makeApiCall('/admin/settings', 'PUT', payload, true);
        showSuccess('Settings saved!');
      } catch (e) {
        // makeApiCall shows error
      }
    }

    async function loadApprovals() {
      try {
        const res = await makeApiCall('/admin/requests', 'GET', null, true);
        const reqs = (res && res.requests) || [];
        const list = document.getElementById('approvalsList');
        if (reqs.length === 0) {
          list.innerHTML = '<div class=\"loading\">No pending requests</div>';
          return;
        }
        list.innerHTML = reqs.map(r => `
          <div class=\"item\">
            <div>
              <strong>${r.name}</strong>
              <div class=\"small\">${r.email}</div>
              <div class=\"small\">Requested: ${new Date(r.createdAt).toLocaleString()}</div>
            </div>
            <div style=\"display:flex; gap:8px;\">
              <button class=\"btn primary\" onclick=\"approveAdmin('${encodeURIComponent(r.email)}')\">Approve</button>
              <button class=\"btn danger\" onclick=\"rejectAdmin('${encodeURIComponent(r.email)}')\">Reject</button>
            </div>
          </div>
        `).join('');
      } catch (e) {
        // makeApiCall shows error
      }
    }

    async function approveAdmin(emailEnc) {
      try {
        await makeApiCall(`/admin/requests/${emailEnc}/approve`, 'POST', null, true);
        showSuccess('Approved'); loadApprovals();
      } catch {}
    }
    async function rejectAdmin(emailEnc) {
      try {
        await makeApiCall(`/admin/requests/${emailEnc}/reject`, 'POST', null, true);
        showSuccess('Rejected'); loadApprovals();
      } catch {}
    }
  </script>
</head>
<body>
  <div class="admin-shell">
    <div class="admin-top">
      <div class="admin-title">Admin Dashboard</div>
      <button class="logout" onclick="logout()">Logout</button>
    </div>

    <div class="admin-nav">
      <button class="admin-tab" data-tab="dashboardPane" onclick="switchTab('dashboardPane')">Dashboard</button>
      <button class="admin-tab" data-tab="busesPane" onclick="switchTab('busesPane')">Edit Bus Details</button>
      <button class="admin-tab" data-tab="settingsPane" onclick="switchTab('settingsPane')">Settings</button>
      <button class="admin-tab" data-tab="approvalsPane" onclick="switchTab('approvalsPane')" id="approvalsTab" style="display:none;">Admin Approvals</button>
    </div>

    <!-- Dashboard Pane -->
    <div id="dashboardPane" class="card" data-pane>
      <div class="section-title">üìä Recent Bus Availability Requests</div>
      <table class="admin-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Time</th>
            <th>Email</th>
            <th>Location</th>
            <th>
              Status
              <select id="statusFilter" onchange="filterLogsByStatus()" style="margin-left: 8px; padding: 2px 4px; border-radius: 4px; border: 1px solid #ddd;">
                <option value="all">All</option>
                <option value="AVAILABLE">Available</option>
                <option value="UNAVAILABLE">Unavailable</option>
              </select>
            </th>
          </tr>
        </thead>
        <tbody id="eventsBody"></tbody>
      </table>
    </div>

    <!-- Approvals Pane (superadmin only) -->
    <div id="approvalsPane" class="card" data-pane style="display:none;">
      <div class="section-title">‚úÖ Approve New Admins</div>
      <div id="approvalsList" class="list"></div>
    </div>
    <!-- Buses Pane -->
    <div id="busesPane" class="card" data-pane style="display:none;">
      <div class="section-title">üöå Manage Buses</div>
      <form onsubmit="addBus(event)" class="grid-3" style="margin-bottom:10px;">
        <input id="busNumber" class="form-input" placeholder="Bus Number (e.g., 101)" required>
        <input id="busName" class="form-input" placeholder="Bus Name (e.g., Bus 101)" required>
        <input id="busLocation" class="form-input" placeholder="Location (e.g., Vijayawada)" required>
        <div></div>
        <div></div>
        <div style="text-align:right;"><button class="btn primary" type="submit">‚ûï Add Bus</button></div>
      </form>
      <div id="busList" class="list"></div>
    </div>

    <!-- Settings Pane -->
    <div id="settingsPane" class="card" data-pane style="display:none;">
      <div class="section-title">‚öôÔ∏è Site Settings</div>
      <form onsubmit="saveSettings(event)" class="grid-2" style="margin-bottom:10px;">
        <div class="form-group">
          <label class="small" for="settingsTitle">Site Title</label>
          <input id="settingsTitle" class="form-input" placeholder="BUS TRANSPORT DETAILS">
        </div>
        <div class="form-group">
          <label class="small" for="settingsOrg">Organization Name</label>
          <input id="settingsOrg" class="form-input" placeholder="Your Institution">
        </div>
        <div class="form-group">
          <label class="small" for="settingsAddress">Contact Address</label>
          <input id="settingsAddress" class="form-input" placeholder="Address line">
        </div>
        <div class="form-group">
          <label class="small" for="settingsPhone">Contact Phone</label>
          <input id="settingsPhone" class="form-input" placeholder="+91 00000 00000">
        </div>
        <div class="form-group">
          <label class="small" for="settingsEmail">Contact Email</label>
          <input id="settingsEmail" type="email" class="form-input" placeholder="support@example.com">
        </div>
        <div></div>
        <div style="text-align:right;"><button class="btn primary" type="submit">üíæ Save Settings</button></div>
      </form>
      <div class="small">These values control the public site header and footer.</div>
    </div>

    <!-- Route Editor Modal -->
    <div id="routeEditorModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalRouteEditorTitle">Edit Routes</h2>
          <span class="modal-close" onclick="closeRouteEditorModal()">&times;</span>
        </div>
        <div class="modal-body">
          <div class="grid-2" style="margin-bottom: 10px;">
            <div class="form-group">
              <label for="modalBusName" class="small">Bus Name</label>
              <input id="modalBusName" type="text" class="form-input" placeholder="e.g., Bus 101">
            </div>
            <div class="form-group">
              <label for="modalBusLocation" class="small">Bus Location</label>
              <input id="modalBusLocation" type="text" class="form-input" placeholder="e.g., Vijayawada">
            </div>
          </div>
          <div class="grid-2" style="margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #ddd;">
            <div class="form-group">
              <label for="busCapacityInput" class="small">Bus Capacity</label>
              <input id="busCapacityInput" type="number" class="form-input" placeholder="e.g., 60">
            </div>
            <div class="form-group">
              <label for="currentOccupancyInput" class="small">Current Occupancy</label>
              <input id="currentOccupancyInput" type="number" class="form-input" placeholder="e.g., 45">
            </div>
          </div>
          <div class="grid-2" style="margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #ddd;">
            <div class="form-group">
              <label for="modalDriverName" class="small">Driver Name</label>
              <input id="modalDriverName" type="text" class="form-input" placeholder="e.g., John Doe">
            </div>
            <div class="form-group">
              <label for="modalDriverPhone" class="small">Driver Phone</label>
              <input id="modalDriverPhone" type="text" class="form-input" placeholder="e.g., +91 9876543210">
            </div>
          </div>
          <div class="form-group" style="margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #ddd;">
            <label for="modalLiveLocation" class="small">Live Location URL</label>
            <input id="modalLiveLocation" type="url" class="form-input" placeholder="https://maps.google.com/...">
          </div>



          <div class="route-editor-tabs">
            <button class="route-editor-tab" data-route-tab="morning" onclick="switchRouteEditorTab('morning')">Morning Route</button>
            <button class="route-editor-tab" data-route-tab="evening" onclick="switchRouteEditorTab('evening')">Evening Route</button>
          </div>

          <div id="morningRouteSection" class="route-editor-section">
            <div class="grid-2">
              <input id="morningStopName" class="form-input" placeholder="Stop name">
              <input id="morningStopCoords" class="form-input" placeholder="Coordinates (lat,lng)">
            </div>
            <div style="text-align:right; margin-top:8px;"><button class="btn" onclick="addStop('morning')">‚ûï Add Stop</button></div>
            <div id="morningStops" class="list"></div>
          </div>

          <div id="eveningRouteSection" class="route-editor-section">
            <div class="grid-2">
              <input id="eveningStopName" class="form-input" placeholder="Stop name">
              <input id="eveningStopCoords" class="form-input" placeholder="Coordinates (lat,lng)">
            </div>
            <div style="text-align:right; margin-top:8px;"><button class="btn" onclick="addStop('evening')">‚ûï Add Stop</button></div>
            <div id="eveningStops" class="list"></div>
          </div>

          <div style="text-align:right; margin-top:20px; border-top: 1px solid #ddd; padding-top: 16px; display: flex; gap: 12px; justify-content: flex-end;">
            <button class="btn" onclick="closeRouteEditorModal()">‚ùå Cancel</button>
            <button class="btn primary" onclick="saveRoutes()">üíæ Save Routes</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
